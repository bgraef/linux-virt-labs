---
# Copyright (c) 2024 2025 Oracle and/or its affiliates.
# This software is made available to you under the terms of the Universal Permissive License (UPL), Version 1.0.
# The Universal Permissive License (UPL), Version 1.0 (see COPYING or https://oss.oracle.com/licenses/upl)
# See LICENSE.TXT for details.

- name: Terminate instances and delete OCI resources
  hosts: localhost
  vars_files:
    - default_vars.yml

  tasks:

    - name: Terminate the instances
      oracle.oci.oci_compute_instance:
        id: "{{ hostvars[item]['instance_ocid'] }}"
        state: absent
      loop: "{{ groups['engine'] + groups['kvm'] }}"

    - name: Delete the vlan
      oracle.oci.oci_network_vlan:
        vlan_id: "{{ my_vlan_id }}"
        state: absent

    - name: Delete network_security_group
      oracle.oci.oci_network_security_group:
        network_security_group_id: "{{ my_l2_vlan_nsg_id }}"
        state: absent

    - name: Delete the subnet2
      oracle.oci.oci_network_subnet:
        id: "{{ my_subnet2_id }}"
        state: absent

    - name: Delete the subnet1
      oracle.oci.oci_network_subnet:
        id: "{{ my_subnet1_id }}"
        state: absent

    - name: Delete the security list
      oracle.oci.oci_network_security_list:
        id: "{{ my_security_list_id }}"
        state: absent

    - name: Delete the private route table
      oracle.oci.oci_network_route_table:
        id: "{{ my_private_rt_id }}"
        state: absent

    - name: Delete the public route table
      oracle.oci.oci_network_route_table:
        id: "{{ my_public_rt_id }}"
        state: absent

    - name: Delete the Service Gateway
      oracle.oci.oci_network_service_gateway:
        id: "{{ my_service_gateway_id }}"
        state: absent

    - name: Delete the Internet Gateway
      oracle.oci.oci_network_internet_gateway:
        id: "{{ my_internet_gateway_id }}"
        state: absent

    - name: Delete the VCN
      oracle.oci.oci_network_vcn:
        vcn_id: "{{ my_vcn_id }}"
        state: absent

    - name: Remove artifacts
      ansible.builtin.file:
        state: absent
        path: "{{ item }}"
      loop:
        - oci_vars.yml
        - buffer
        - hosts
