---
# Copyright (c) 2024 2025 Oracle and/or its affiliates.
# This software is made available to you under the terms of the Universal Permissive License (UPL), Version 1.0.
# The Universal Permissive License (UPL), Version 1.0 (see COPYING or https://oss.oracle.com/licenses/upl)
# See LICENSE.TXT for details.

- name: Wait for KVM Hosts to be Up
  hosts: olvm
  gather_facts: false
  vars_files:
    - default_vars.yml
    - oci_vars.yml

  tasks:

    - name: Connect to the OLVM Engine application # noqa: syntax-check[unknown-module]
      ovirt.ovirt.ovirt_auth:
        url: "{{ engine_url }}"
        username: "{{ engine_user }}"
        password: "{{ engine_pass }}"
        ca_file: "{{ ansible_env.HOME + '/pki-resource' }}"
        insecure: true
      when: ovirt_auth is undefined or not ovirt_auth
      register: auth_connection
      tags:
        - always

    - name: Gather host information until it's up
      ovirt.ovirt.host_info:
        pattern: name=olkvm*
      register: host_info
      until:
        - host_info.ovirt_hosts | length > 0
        - host_info.ovirt_hosts[ {{ ansible_loop.index0 }} ].status == "up"
      loop: "{{ groups['kvm'] }}"
      loop_control:
        extended: true
      retries: 30  # Number of times to retry
      delay: 10    # Delay between retries in seconds

    - name: Check if the host is up
      debug:
        msg: "Host {{ host_name }} is up and running"
