# Copyright (c) 2024 2025 Oracle and/or its affiliates.
# This software is made available to you under the terms of the Universal Permissive License (UPL), Version 1.0.
# The Universal Permissive License (UPL), Version 1.0 (see COPYING or https://oss.oracle.com/licenses/upl)
# See LICENSE.TXT for details.
---

- name: Add oracle-ovirt release repository
  ansible.builtin.dnf:
    name:
      - oracle-ovirt-release-45-el8
      - kernel-uek-modules-extra
    state: present

- name: Set ovirt-4.5 repo to public YUM mirror
  community.general.ini_file:
    path: /etc/yum.repos.d/oracle-ovirt-45-ol8.repo
    section: ovirt-4.5
    option: baseurl
    value: https://yum.oracle.com/repo/OracleLinux/OL8/ovirt45/$basearch/
    mode: "0644"
    state: present

- name: Set ovirt-4.5-extra to public YUM mirror
  community.general.ini_file:
    dest: /etc/yum.repos.d/oracle-ovirt-45-ol8.repo
    section: ovirt-4.5-extra
    option: baseurl
    value: https://yum.oracle.com/repo/OracleLinux/OL8/ovirt45/extras/$basearch/
    mode: "0644"
    state: present

- name: Set ol8_kvm_appstream to public YUM mirror
  community.general.ini_file:
    dest: /etc/yum.repos.d/virt-ol8.repo
    section: ol8_kvm_appstream
    option: baseurl
    value: https://yum.oracle.com/repo/OracleLinux/OL8/kvm/appstream/$basearch/
    mode: "0644"
    state: present

- name: Install ovirt-engine
  ansible.builtin.dnf:
    name: ovirt-engine
    state: present
  when: inventory_hostname in groups['server']

- name: Activate Cockpit web console
  ansible.builtin.systemd:
    state: started
    name: cockpit.socket
    enabled: true
  when: inventory_hostname in groups['kvm']

- name: Open firewall for cockpit and virsh
  ansible.posix.firewalld:
    zone: public
    service: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - libvirt
    - libvirt-tls
    - cockpit
